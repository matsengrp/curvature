\documentclass{amsart}

\usepackage{amsmath}
\usepackage{ifthen}
\usepackage{todonotes}
\usepackage[notref,notcite]{showkeys} % show keys for eqs, etc.
\usepackage{cite}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{example}[theorem]{Example}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{conjecture}[theorem]{Conjecture}

\renewcommand{\theenumi}{\roman{enumi}}

\newcommand{\RR}{\mathbb R}
\newcommand{\TT}{\mathcal T}

\newcommand{\cuttable}[1]{#1} % In case we need to be succinct for limits.

%---[ Parenthesization ]--------------------------------------------------------

\newcommand{\newparentheses}[3]{%
  \expandafter\newcommand\csname #1\endcsname[1]{#2##1#3}%
  \expandafter\newcommand\csname #1L\endcsname[1]{\bigl#2##1\bigr#3}%
  \expandafter\newcommand\csname #1XL\endcsname[1]{\Bigl#2##1\Bigr#3}%
  \expandafter\newcommand\csname #1XXL\endcsname[1]{\biggl#2##1\biggr#3}%
  \expandafter\newcommand\csname #1V\endcsname[1]{\left#2##1\right#3}}

\newparentheses{parens}{(}{)}
\newparentheses{floor}{\lfloor}{\rfloor}
\newparentheses{ceil}{\lceil}{\rceil}
\newparentheses{abs}{|}{|}
\newparentheses{set}{\{}{\}}
\newparentheses{size}{|}{|}

%---[ Attributes ]--------------------------------------------------------------

\makeatletter
\newcommand{\onenewattribute}[3]{%
  \@ifundefined{#1}{\let\@@def\newcommand}{\let\@@def\renewcommand}%
  \expandafter\@@def\csname #1\endcsname[2][]{%
    \ifthenelse{\equal{##1}{}}%
    {#2\csname #3\endcsname{##2}}%
    {#2_{##1}\csname #3\endcsname{##2}}}}
\newcommand{\newattribute}[2]{%
  \onenewattribute{#1}{#2}{parens}%
  \onenewattribute{#1L}{#2}{parensL}%
  \onenewattribute{#1XL}{#2}{parensXL}%
  \onenewattribute{#1V}{#2}{parensV}}
\makeatother

%---[ Asymptotic notation ]-----------------------------------------------------

\newattribute{OhOf}{\mathrm{O}}
\newattribute{ThetaOf}{\Theta}
\newattribute{OmegaOf}{\Omega}
\newattribute{ohOf}{\mathrm{o}}
\newattribute{omegaOf}{\omega}
\newattribute{lca}{\text{LCA}}
%\newattribute{min}{\text{min}}
%\newattribute{max}{\text{max}}

%---[ Distance measures, invocations, etc ]-------------------------------------
\newattribute{dspr}{d_{\mathrm{SPR}}}
\newparentheses{degree}{|N(}{)|}

%---[ curvature ]---------------------------------------------------------------
\newcommand{\curvature}[2][]{%
    \ifthenelse{\equal{#1}{}}%
		{\kappa_n(#2)}%
		{\kappa_n(#1;#2)}%
}


\begin{document}
\title[Curvature of phylogenetic subtree-prune-regraft graph]{Ricci-Ollivier curvature of two random walks on rooted phylogenetic subtree-prune-regraft graph}
\author[Whidden]{Christopher Whidden}
\author[Matsen]{Frederick A Matsen IV}
\address{}
\thanks{}

\date{\today}

\begin{abstract}
Statistical phylogenetics inference methods use tree rearrangement operations to perform either local hill-climbing search or Markov chain Monte Carlo across tree topologies.
The canonical class of such moves are the subtree-prune-regraft (SPR) moves that remove a subtree and reattach it somewhere else via the cut edge of the subtree.
Phylogenetic trees and such moves naturally form the vertices and edges of a graph, such that tree search algorithms perform a (potentially stochastic) traversal of the graph.
Despite the centrality of such graphs in phylogenetic inference, rather little is known about their large-scale properties.
In this paper we learn about the rooted-tree version of the graph, known as the rSPR graph, by calculating the recently-developed notion of Ricci curvature for pairs of vertices in the rSPR graph with respect to two simple random walks on the rSPR graph.
This notion of curvature is especially relevant to stochastic search on the graph.
By proving theorems and direct calculation, we find a remarkable diversity of different curvatures on the rSPR graph for pairs of vertices separated by the same distance.
This indicates significant structure of the graph, and a greater understanding of this structure could ultimately lead to improved strategies for tree search.

We find that indeed there is
\end{abstract}

\maketitle

% % Make a todo table of contents.
% \makeatletter
% \providecommand\@dotsep{5}
% \makeatother
% \listoftodos\relax


\section{Introduction}
Molecular phylogenetic methods, which reconstruct evolutionary trees from DNA or RNA data, are of fundamental importance to modern biology.
Statistical phylogenetics forms the currently most popular means of reconstructing phylogenetic trees, in which the tree is viewed as an unknown parameter in a likelihood-based statistical inference problem.
The likelihood function in this setting is the likelihood of generating the observed sequences via a continuous time Markov chain (CTMC) evolving down the tree starting from a sequence assumed to be sampled from the stationary distribution (cite{Felsenstein}).
The lengths of the branches of the phylogenetic tree give the ``time'' parameter in the CTMC, where the generated sequence accrues mutations, typically in an IID manner across sites.
Thus likelihood-based phylogenetics gives an optimality criterion that comes from both branch length and topology.
Within this framework researchers typically choose either a Bayesian approach, in which an algorithm (typically Markov chain Monte Carlo or MCMC) approximates the posterior distribution of trees and their associated parameters, or a maximum likelihood (ML) approach, in which an algorithm searches across tree topologies and continuous parameters in order to find the combination with the highest likelihood.

In order to get accurate such estimates, MCMC samplers must sufficiently explore the collection of trees, or heuristic local search algorithms must find a way to the ML tree, avoiding and escaping local peaks.
In both settings, one needs a means of describing the trees that are ``near'' to the current tree.
% Here we focus on the discrete search part.
There are a number of such means of doing so.
SPR.
SPR graph.
For MCMC moves, one would like to ensure good mixing.
For ML moves, we are concerned about local optima.
We will call these "graph effects"-- can't get easily from one spot to another because of structure of the graph.
We use "random walks" as being a general notion of movement around a graph, including MCMC.

Researchers have noticed SPR graph effects in MCMC.
\cite{Mossel2005-ly,Mossel2006-fo}
\cite{Ronquist2006-fv}
\cite{Stefankovic2011-hu}
We recently showed that graph structure has an effect of MCMC mixing using real data and programs.
\cite{Whidden2015-yi}
Probabilists have also approached the problem using related frameworks that are more amenable to proving theorems, both for other sets of moves on trees with a finite number of leaves \cite{Aldous2000-vg,Diaconis2002-gy} or for SPR and related moves on a continuous tree-like object called the compact real tree which formalizes the notion of a tree with infinite leaves\cite{Evans2006-xh,Athreya2014-de}.

ML also has graph effects, which manifest as local maxima.
There have been investigation of local maxima, but concern branch lengths.
\cite{Fukami1989-fs,Steel1994-pt,Chor2003-wh,Chor2000-ea}
The work on SPR moves in the ML context is primarily found in the literature comparing various SPR variants to one another, usually in the context of comparing one phylogenetic software package to another \cite{Hordijk2005-dl,Stamatakis2006-yz,Price2010-fi,Guindon2010-lo}.
We are not aware of any general conclusions concerning hill-climbing on the SPR or related graphs that has come from this work.

The SPR graph is very important in phylogenetic inference, and yet still little is known about the rooted or unrooted versions of the SPR graph itself, or random walks thereupon.
\cite{Song2003-gf} developed a recursive procedure on a tree to find the degree of the corresponding vertex in the rSPR graph, and corresponding bounds on degree.
\cite{Ding2011-bj} showed that the diameter $\Delta_{\text{rSPR}}$ of the rSPR graph is $n - \Theta(\sqrt n)$, and for the unrooted case they show
$$ n - 2\ceil{\sqrt{n}} + 1
\le \Delta_{\text{uSPR}}(n)
\le n - 3 - \floorV{\frac{\sqrt{n - 2} - 1}{2}}.
$$
Despite the centrality of the SPR graph to phylogenetic inference, we are not aware of any other work investigating its properties.

Recently, a new approach to quantifying properties of discrete and continuous spaces with respect to random walks has been pioneered by Ollivier and colleagues \cite{Ollivier2009-bw,Joulin2010-jg}.
They define a notion of curvature on a discrete or continuous case.
Formalizes idea of the extent to which random walking brings points together, and is generalization of the notion of Ricci curvature on manifolds.

In this paper, we investigate curvature of the rSPR graph with respect to two different random walks and make connections to access times for those random walks.
For this first effort we investigate random walks defined in terms of the graph itself: the lazy uniform random walk and MCMC sampling from the uniform prior on trees.
By getting a more fine-tuned understanding of the rSPR neighborhood of pairs of vertices, we are able to give bounds on curvatures under these random walks.
By exploiting symmetries in the rSPR graph, we are able to calculate all of the curvatures for pairs of trees with up to seven leaves.
Using simulation of these processes, we find that the distribution of access times between pairs of trees can be described by distance between the trees, the degrees of the trees, and the curvature.


\section{Preliminaries}
\begin{equation}
\curvature{x, y} := 1 - \frac{W_1(m_x, m_y)}{d(x, y)}
\label{eq:curvatureDef}
\end{equation}

Rooted $X$-trees.
Leaf restriction notation with $|$.
We are talking about rooted, and would like to make it clear that this is not the most realistic graph to consider.
Our motivations for considering this graph are because it is understandable, and some programs do rSPR-type moves.
Note that in rSPR you can move subtrees to the root.
Parent and parent subtree.
Define adjacency of subtrees.

For the rest of the paper, \textbf{we will assume that all phylogenetic trees are rooted,} and thus that tree inclusion is rooted tree inclusion.
A \emph{parent (sub)tree} of a subtree $U$ is the smallest subtree strictly containing $U$.
A \emph{parent edge} of a subtree $U$ is the edge connecting $U$ to the rest of the tree.
The \emph{internal edges} of a tree are the edges that do not contact a leaf (we do not consider a rooted tree to have a ``root edge'', so trees have a degree two root).
A \emph{ladder tree} is a tree such that every internal vertex has a leaf as a direct descendant.
LCA of subtrees.

\section{Access times of random walks on the rSPR graph can be understood using distance, degree, and curvature}

After the chain has achieved stationarity, one sees a


\section{Rooted SPR Neighborhoods}

Let $N(T)$ be the set of SPR neighbors of a tree $T$ (this does not include $T$).
We say that the degree of $T$ is $\degree{T}$, that is, the number of trees which can be obtained from $T$ by a single SPR operation.
Note that this concept of degree is unrelated to the degree of vertices of $T$.
In the absence of a bias provided by a likelihood function, curvature for the random walks we consider is entirely determined by the degree of vertices in the graph.
Thus, in order to provide bounds on curvature, we will begin by bounding differences between degrees.

\begin{lemma}[{Song \cite{Song2003-gf}}]
    \pushQED{\qed}
	\label{lem:degree_extremes}
	Let $T$ be a rooted phylogenetic tree with $n$ leaves. Then
	\begin{enumerate}
		\item $\degree{T} = 3n^2 - 13n + 14$, if $T$ is a ladder tree,
		\item $\degree{T} = 4(n-2)^2 - 2 \sum_{m=1}^{n-2} \floor{\log_2(m+1)}$, if $T$ is a balanced tree, and
		\item  $3n^2 - 13n + 14 \le \degree{T} \le 4(n-2)^2 - 2 \sum_{m=1}^{n-2} \floor{\log_2(m+1)}$, otherwise.
	\end{enumerate}
    \popQED
\end{lemma}

We now bound the relative and exact difference in SPR degree between two trees with $n$ leaves.

\begin{lemma}
	\label{lem:degree_max_delta}
	Let $T$ and $S$ be rooted phylogenetic trees with $n \ge 3$ leaves, and assume without loss of generality that $\degree{T} \le \degree{S}$.
	Then:
	\begin{enumerate}
		\item $\frac{\degree{T}}{\degree{S}} \ge \frac{3}{4}$, and
		\item $\degree{S} - \degree{T} \le n^2 - 5n + 6$.
	\end{enumerate}
\end{lemma}
\begin{proof}
	To prove (i), we simply note from Lemma~\ref{lem:degree_extremes} that the ladder tree achieves the minimum degree, and the balanced tree achieves the maximum degree:
	\begin{align*}
		\frac{\degree{T}}{\degree{S}} \ge\ &\frac{3n^2 - 13n + 14}{4(n-2)^2 - 2 \sum_{m=1}^{n-2} \floor{\log_2(m+1)}} \\
		\ge\ &\frac{3n^2 - 13n + 12}{4(n-2)^2 - 2(n-2)} \\
		\cuttable{= \ &\frac{3n^2 - 13n + 12}{4n^2 - 16n + 16 - 2(n-2)} \\}
		= \ &\frac{3n^2 - 13n + 12}{4n^2 - 18n + 20} \\
		\cuttable{\ge\ &\frac{3n^2 - 13n + 12}{4n^2 - 17\frac{1}{3}n + 18} &\forall n \ge 3 \\}
	\end{align*}
	which is greater than 3/4 when $n \ge 3$.
    Similarly for (ii):
	\begin{align*}
		\cuttable{\degree{S} - \degree{T}
		\le\ &(4(n-2)^2 - 2 \sum_{m=1}^{n-2} \floor{\log_2(m+1)})
		- (3n^2 - 13n + 14) \\}
		\le\ &(4(n-2)^2 - 2(n-2)) - (3n^2 - 13n + 14) \\
		\cuttable{=\ &4n^2 - 16n + 16 - 2n +4 - 3n^2 + 13n - 14 \\}
		=\ &n^2 - 5n + 6.
	\end{align*}
\end{proof}

We can improve these bounds in the case of adjacent trees.
To do so, we require the following lemma that characterizes exactly how the degree of a tree changes after an rSPR operation.

\begin{lemma}
\label{lem:degree_change}
Let $T$ and $S$ be phylogenetic trees such that $T$ can be obtained from $S$ by moving a subtree $R$ with $k$ leaves from its position adjacent to subtree $U$ to a location adjacent to subtree $V$.
Let $L$ be the $\lca{U,V}$ in $T$.
Let $a$ be the number of intermediate vertices on the path from the parent of $R$ to $L$ in $T$, excluding endpoints.
Similarly, let $b$ be the number of intermediate vertices on the path from $V$ to $L$ in $T$, excluding endpoints.
Let $i$ be the number of leaves in $U$ and $j$ be the number of leaves in $V$, excluding any leaves of $R$.
Then the degrees of $T$ and $S$ differ by:
$$2\left(k(a-b) + i - j\right).$$

\end{lemma}
\begin{proof}
The set of permissible SPR moves changes in four different ways due to the movement of $R$:
(i) subtrees that include vertices on the path from $U$ to $L$ may now be moved into $R$ and its newly introduced parent vertex,
(ii) subtrees that include vertices on the path from $V$ to $L$ may no longer be moved into $R$ and its parent vertex,
(iii) $R$'s parent subtree may now be moved into $U$, and
(iv) $R$'s parent subtree may no longer be moved into $V$.
No additional moves are introduced or blocked by the original SPR operation on $R$.

Recall that a rooted tree with $k$ leaves has $2(k-1)$ internal edges (recall that we are excluding any ``root edge'' in these calculations).
In the first case there are $a$ subtrees that can now be moved onto the $2k$ edges in $R$ (including its newly introduced parent edge and one of the newly subdivided root edges of $V$) for a total gain of $2ka$ distinct moves.
Similarly, we lose $2kb$ moves in the second case.
In the third case, $R's$ parent subtree may now make $2(i-1)$ moves into $U$.
Similarly, we lose $2(j-1)$ moves in the fourth case.

The difference in SPR degree is thus $2ka - 2kb + 2(i-1) - 2(j-1)$ as claimed.
\end{proof}

Moreover, we can use these ideas to determine the number of SPR moves that are, in some respects, independent of a given SPR move.
That is, for two trees $S$ and $T$ differing by a single SPR move, we wish to know the number of SPR moves that are applicable to both trees rather than unique to one of the trees.
To formalize this concept, we consider pairs of trees $T' \in N(T)$ and $S' \in S(T)$ such that $\dspr{T',S'} = 1$.
The number of such ``squares'' involving two adjacent trees will play a key rule in our bounds on curvature, as they push the curvature of those trees towards 0.

\begin{corollary}
\label{cor:paired_neighbors}
Continuing with the setting and notation in Lemma~\ref{lem:degree_change}, at least
$$o := \deg(T) - 2kb - 2(j-1) = \deg(S) - 2ka - 2(i-1)$$
trees in the neighborhood of $T$ can be paired with $o$ trees in the neighborhood of $S$ such that the pairings are disjoint and $\dspr{T',S'} = 1$ for each $(T',S')$ pair.
\end{corollary}
\begin{proof}
By the same arguments as in the proof of Lemma~\ref{lem:degree_change}, $o$ SPR moves can be applied to $T$ and $S$ with the same source and target vertices.
For each such $(T',S')$ pair, we can move $R$ in either tree to obtain the other member of the pair.
\end{proof}

We can now use Lemma~\ref{lem:degree_change} to improve the bounds in Lemma~\ref{lem:degree_max_delta} for the case of two adjacent trees.
\begin{lemma}
	\label{lem:degree_max_delta_adjacent}
	Let $T$ and $S$ be rooted phylogenetic trees with $n \ge 3$ leaves, such that $\degree{T} \le \degree{S}$ and $\dspr{T,S} = 1$.
	Then:
	\begin{enumerate}
		\item $\degree{S} - \degree{T} \le 2\floor{\frac{n-2}{2}}\ceil{\frac{n-2}{2}} \le \frac{1}{2} (n-2)^2 $.
		\item $\frac{\degree{T}}{\degree{S}} \ge \frac{5}{6}$, $\forall n \ge 4$, and
		\item $\lim_{n\rightarrow\infty}\frac{\degree{T}}{\degree{S}} =  \frac{6}{7}$.
	\end{enumerate}
\end{lemma}
\begin{proof}
	We first prove (i).
	By Lemma~\ref{lem:degree_change}, $\degree{S} - \degree{T} = 2(k(a-b) + i - j)$.
	This value is maximized by making $L$ the root and minimizing $b$, namely by setting $b=0$.
	The resulting equation $2(ka + i - j)$ is similarly maximized by setting $i=1$ (which allows us to increase $a$) then maximally balancing the terms in the product $ka$ as follows.

	There are two cases, depending on whether the subtree of $k$ leaves is moved to the root or not.
    If not, then we set $j=1$ and split the remaining $n-b-i-j = n-2$ leaves between $k$ and $a$ in as balanced a way as possible, giving (i).
	Note that this corresponds to moving the bottom subtree of $\floor{\frac{n-2}{2}}$ or $\ceil{\frac{n-2}{2}}$ leaves in a ladder tree to the root-most leaf of the tree.

	If the subtree of $k$ leaves is moved to the root, then we do not need to exclude the target branch from $k$ and $a$, gaining an additional leaf to balance the product $ka$ at the cost of increasing $j$.
	This corresponds to moving the bottom subtree of $\floor{\frac{n}{2}}$ or $\ceil{\frac{n}{2}}$ leaves in a ladder tree to the root.
	Namely, we have $2(ka + 1 - j)$, where $j = n - k = a + 1$.
	If we move the additional leaf, we have:
$$\degree{S} - \degree{T} \le 2\left(\ceilXXL{\frac{n}{2}}\floorV{\frac{n-2}{2}}  + 1 - \left(\floorV{\frac{n-2}{2}} + 1\right)\right) = 2\floorV{\frac{n-2}{2}}\ceilV{\frac{n-2}{2}}$$
like before.
Similarly, if we do not move the additional leaf, we also have:
$$\degree{S} - \degree{T} \le 2 \left(\ceilV{\frac{n-2}{2}}\floorXXL{\frac{n}{2}} +1 -  \left(\ceilV{\frac{n-2}{2}} + 1\right)\right) = 2\floorV{\frac{n-2}{2}}\ceilV{\frac{n-2}{2}},$$
proving (i).

The relative change in degree, $\frac{\degree{T}}{\degree{S}}$, can also be written as $\frac{\degree{T}}{\degree{T} + (\degree{S} - \degree{T})}$.
By (i), we have that $\degree{S} - \degree{T} \le \frac{1}{2} (n-2)^2$,
so $\frac{\degree{T}}{\degree{S}} \ge \frac{\degree{T}}{\degree{T} + \frac{1}{2} (n-2)^2} $.
This bound is minimized when $\degree{T}$ is minimized, and recall by Lemma~\ref{lem:degree_extremes} that $\degree{T}$ is bounded below by $3n^2 - 13n + 14$.
	Thus
	\begin{align*}
		\frac{\degree{T}}{\degree{S}} &\ge \frac{3n^2 - 13n + 14}{3n^2 - 13n + 14 + \frac{1}{2}(n-2)^2} \\
		&\ge \frac{3n^2 - 13n + 14}{3.5n^2 - 15n + 16}.
	\end{align*}
	Statements (ii) and (iii) follow from this bound.
    % 3*16 - 13*4 + 14 = 10
    % 3.5*16 - 15*4 + 16 = 12

\end{proof}


Next, we bound the number of neighbors shared by two adjacent trees.
The number of such "triangles" involving two adjacent trees has a key role in determining whether the curvature of two adjacent trees is positive or negative.

\begin{lemma}
	\label{lem:shared_neighbors}
Let $T$ and $S$ be rooted $X$-trees such that $\dspr{T,S} = 1$.
Then $\size{N(T) \cap N(S)} \le 6n - 17$.
\end{lemma}

\begin{proof}
	$T$ and $S$ differ by one SPR move that moves a subtree $R$.
	Pick a neighbor $U \in N(T) \cap N(S)$ of both $T$ and $S$ (this intersection is not empty: $T$ and $S$ are different, so $R$ contains at most $n-2$ of the leaves, thus there must be at least one other tree $U$ obtained by moving $R$ in $T$ and $S$).
	Then either (i) $T$ and $U$ differ in the location of $R$, or (ii) $T$ and $U$ differ in the location of another subtree $Q$.
	In the latter case, $T|(X \setminus L(Q)) = S|(X \setminus L(Q))$ because $T$ and $S$ differ only in the location of $R$ and $\dspr{T,U} = \dspr{S,U} = 1$.
	Then leaves $r' \in R$, $q' \in Q$, and $u' \in U$, for some subtree $U$, form a triple of $T$ and a different triple in $S$.
	This incompatible triple can be resolved in at most $6n - 17$ ways, the maximum of which is reached when $Q$, $U$, and $R$ are themselves a ``triple'' of subtrees.
	By Lemma~\ref{ }\todo{need unique move lemma}, each of the subtrees is assigned to at most $2n-6$ unique moves.
	Moreover, one additional overlapping move also moves one of the subtrees (that of the aunt of the LCA of the three subtrees).
	The number of shared neighbors is thus at most $3(2n-6) + 1 = 6n-17$.
	Note that this bound is tight when, for example, $T$ and $S$ are ladders with a different configuration of 3 leaves at maximum depth.
\end{proof}





\section{Curvature}
For the purposes of this paper, $\kappa_n$ is the Ricci-Ollivier curvature \eqref{eq:curvatureDef} on the $n$-taxon rSPR graph with respect to a specified random walk and $W_{1,n}$ is the corresponding mass transport term.

We first consider properties of the uniform random walk on the rSPR graph.
Assume that the random walk begins at a tree $T$.
The uniform random walk selects a tree uniformly at random from $N(T)$.
We denote the curvature of the uniform random walk between two trees $T$ and $S$ with $\curvature{T,S}$.
Recall that $\curvature{T, S} := 1 - \frac{W_1(m_T, m_S)}{d(T, S)}$.
For the uniform random walk, $m_T$ is  simply the set
\todo{AlexG: Technically, $m_T$ is a measure on the set of vertices of the rSPR.}
of neighbors of $T$ each assigned a mass of $\frac{1}{\degree{T}}$.

\begin{proposition}
Fix a positive integer $k$ and let $R$ be a tree with $k$ leaves.
Let $\{T_n \mid n > k\}$ be a sequence of phylogenetic trees all containing $R$, and let $\{S_n \mid n > k\}$ be the same sequence $T_n$ but with $R$ cut off and attached at a different location.
Then $\lim_{n \rightarrow \infty} \curvature{T_n,S_n} = 0$ for the uniform random walk on the SPR graph.
\end{proposition}
\begin{proof}
Because $d(T_n, S_n) = 1$, we will prove the proposition by showing that the mass transport term $W_{1,n}$ sits between two bounds, each of which has limit 1 as $n$ goes to infinity.

To start we demonstrate the proposition in the case that $T_n$ and $S_n$ have the same number of neighbors.
First we claim that $W_{1,n}$ is bounded above by $(\degree{T_n}+\OhOf{kn})/\degree{T_n}$ by exhibiting a mass transport program satisfying that bound.
Let $(T'_n, S'_n)$ be any of the $o$ pairs of neighbors of $(T_n, S_n)$ which are one SPR move apart as per Corollary~\ref{cor:paired_neighbors}.
We pair the these trees in the mass transport.
There are $\OhOf{kn}$ trees unmatched by this pairing, and we can pair each of them arbitrarily with another tree of distance at most 3.
Thus, $W_{1,n}$ is bounded above by $(\degree{T_n} + \OhOf{kn}) / \degree{T_n}$.

A lower bound is also available because we can't do better than distance 1 for all trees except for shared neighbors, of which there are $\OhOf{n}$ by Lemma~\ref{lem:shared_neighbors}.
By ignoring these trees we get a lower bound of $(\degree{T_n} - (\OhOf{n}))/\degree{T_n}$ for $W_{1,n}$.

The desired control of $W_{1,n}$ is thus obtained because $\degree{T_n}$ is quadratic in $n$.

Now we prove the proposition when the number of neighbors differ.
Assume without loss of generality that $\degree{T_n} < \degree{S_n}$.
By Lemma~\ref{lem:degree_change}, $\degree{S_n} - \degree{T_n} = 2(k(a-b) + i - j)$, where each of $\{a,b,i,j\}$ is less than $n$.
Thus, $\degree{S_n} - \degree{T_n} = \OhOf{kn}$.
We again pair neighbor $T'_n$ of $T$ with neighbor $S'_n$ of $S$ such that $\dspr{T'_n, S'_n}=1$ but, as $\degree{T_n} < \degree{S_n}$ we can only account for at most $\degree{T_n} / \degree{S_n}$ of the mass directly and may have to move the $(\degree{S_n} - \degree{T_n}) / \degree{S_n}$ remainder to trees a distance at most 3.
Thus, $W_{1,n}$ is bounded above by $(\degree{T_n} + \OhOf{kn}) / \degree{S_n} = (\degree{S_n} + \OhOf{kn}) / \degree{S_n}$.
We again bound $W_{1,n}$ from below with $(\degree{T_n} - \OhOf{n}) / \degree{T_n}$ by ignoring the mass in common neighbors of $T_n$ and $S_n$.
The proposition again follows because $\degree{T_n}$ is quadratic in $n$.

\end{proof}

Next we note a rough bound on the curvature of two trees with respect to their distance.

\begin{lemma}
	\label{lem:curvature_distance_bound}
	Let $T$ and $S$ be two trees. Then:
	$$ \frac{-2}{\dspr{T,S}} \le \curvature{T,S} \le \frac{2}{\dspr{T,S}} .$$
\end{lemma}
\begin{proof}
	Observe that the distance between neighbors of $T$ and $S$ is bounded between $\dspr{T,S} - 2$ and $\dspr{T,S} + 2$.
	For the curvature upper bound, we then have $\curvature{T,S} \le 1 - \frac{\dspr{T,S} - 2}{\dspr{T,S}} = \frac{2}{\dspr{T,S}}$.
	The lower bound follows similarly.
\end{proof}

Next we obtain a tighter bound on the maximum curvature of two adjacent trees.
\begin{lemma}
	The maximum curvature of the uniform random walk between two adjacent trees with $n$ leaves is $\frac{6n-17}{3n^2-13n+14}$.
\end{lemma}
\begin{proof}
The maximum curvature between adjacent trees $T$ and $S$ occurs when their neighborhoods have maximum overlap and all other tree pairs are at distance 1.
By Lemma~\ref{lem:shared_neighbors} the maximum overlap is $6n-17$.
The amount of overlapping mass in the shared neighbors of $T$ and $S$ is thus $\frac{6n-17}{\max(\degree{T},\degree{S})}$.
The minimum mass transfer cost is thus $1 - \frac{6n-17}{\max(\degree{T},\degree{S})}$.
This is minimized when $\degree{T}=\degree{S}$ are as small as possible, that is $T,S$ are ladders and $\degree{T} = 3n^2 - 13n + 14$.

The maximum curvature is thus $1 - \frac{\degree{T} - (6n-17)}{\degree{T}} = \frac{6n - 17}{\degree{T}}= \frac{6n-17}{3n^2-13n+14}$.
\end{proof}
This bound is tight and has been verified computationally for $n \le 7$.

It is more difficult to obtain a closer bound on the maximum curvature of nonadjacent trees.
Lemma~\ref{lem:curvature_distance_bound} suggests that more distant pairs of trees should have smaller curvatures than close trees as neighborhood effects decrease with respect to the increasing distance.
However, our experiments with $n \le 7$ suggest that maximum curvature tends to increase with distance (with respect to a fixed $n$), as a far greater fraction of the neighbors approach each other as the distance increases.
Indeed, for $5 \le n \le 7$ the maximum curvature is obtained by pairs of trees at one less than the maximum distance.
Moreover, nearly all of the neighbors of these pairs approach each either.
We thus conjecture the following:
\begin{conjecture}
	Let $k_n$ be the maximum curvature of the uniform random walk on trees of $n$ leaves.
	Then:
	\begin{enumerate}
		\item $k_n \le \frac{2}{\Delta_{\text{rSPR}}(n)-1}$.
		\item $\lim_{n\rightarrow\infty} k_n  = \frac{2}{\Delta_{\text{rSPR}}(n)-1}$
	\end{enumerate}
\end{conjecture}
Proving or disproving this conjecture would go a long way toward understanding the effects of relative distance on curvature.
However, we suspect that this will require a greater understanding of the distribution of tree neighborhoods with respect to one another than is currently known.
\todo{Do you have some key lemmas that could be tested computationally to isolate the problem?}
Next, we bound the minimum curvature of two adjacent trees.

\begin{lemma}
	The curvature of the uniform random walk between two adjacent trees with $n$ leaves is at least
	$$\frac{-n^2 + 2n}{3.5n^2 - 15n + 16}.$$
\end{lemma}
\begin{proof}
    In light of Corollary \ref{cor:paired_neighbors}, the optimal mass transport cost is maximized (and therefore curvature minimized) across adjacent trees $T$ and $S$ by a combination of two effects: trees that cannot be paired at distance $1$ and mass that must be moved between unpaired trees due to differing degrees of $T$ and $S$.
		As we will show, these effects can be optimized simultaneously.
    To bound these effects, let $m$ be the maximum (across $T$ and $S$) proportion of mass that cannot be moved between adjacent neighbors of those trees.
    We can bound the mass transport cost from above by $1 + 2m$ because pairs of neighbors of adjacent trees are at most distance 3 apart.
	This gives a lower bound of $1 - (1 + 2m) / 1) = -2m$ on the curvature.

	By Lemmas~\ref{lem:degree_change} and~\ref{lem:degree_max_delta_adjacent}, the latter effect is maximized when the relative degree change is maximized.
	By Corollary~\ref{cor:paired_neighbors}, there are at most $o := \degree{T} -2ka - 2(i-1)$ paired trees, bounding the former effect.
	We now construct a pair of trees that maximizes both effects.
	Let $S$ be the ladder tree with degree $3n^2 - 13n + 14$ and $T$ be the adjacent tree constructed by moving the lower $\floor{\frac{n}{2}}$ leaves of $S$ to the root.
	$T$ has degree at most $3.5n^2 -15n + 16$.
	There are thus $2ka + 2(i-1) = 2\left(\ceil{\frac{n-2}{2}}\floor{\frac{n}{2}} +(1-1)\right) \le \frac{1}{2}n^2 - n$ unpaired neighbors, the maximum possible.
	Moreover, as shown by Lemma~\ref{lem:degree_change} this pair of trees obtains the maximum (absolute and relative) degree change.
	Thus, the maximum $m$ is:
	$$\frac{\frac{1}{2}n^2 - n}{3.5n^2 - 15n + 16}.$$
	The claim follows from multiplying this value by $-2$.
\end{proof}

We further observe that the limit of our curvature lower bound is $-\frac{2}{7}$.
Complete enumeration with $n \le 7$ show that no pair of trees have curvature less than $-\frac{2}{5}$ and our bound meets or exceeds this value for $n > 7$.
Moreover, the SPR distance is a metric, so this bounds the curvature for arbitrary pairs of trees (Proposition 19 of \cite{Ollivier2009-bw}).
This directly leads to the following Corollary:

\begin{corollary}
	The curvature of the uniform random walk between two phylogenetic trees is at least $-\frac{2}{5}$.
\end{corollary}

Note that this bound is not tight (at least for small $n$) as it is rarely necessary to transport mass the maximum distance between unpaired trees.

We next bound the effect of laziness on curvature.
The lazy random walk again selects a tree uniformly at random, as with the uniform random walk, but only accepts the move with probability $p$.
We denote the curvature of the lazy random walk between two trees $T$ and $S$ by $\curvature[\ell_p]{T,S}$.
For example, $\curvature[\ell_{\frac{1}{4}}]{T,S}$ describes the curvature of the lazy random walk that moves with probability $\frac{1}{4}$ and remains stationary with probability $\frac{3}{4}$.
For the lazy random walk, $m_T$ is now $T \cup N(T)$, with each neighbor assigned mass $\frac{p}{\degree{T}}$ and $T$ assigned the remaining $1 - p$ mass.
Note that Ollivier defined $\curvature[\ell_p]{T, S} := \left(1 - \frac{W_1(m_T, m_S)}{d(x, y)}\right) / p$~\cite{Ollivier2009-bw}.
This definition of curvature is invariant of $p$ for small enough $p$ and was used by Ollivier to avoid parity problems on graphs where the uniform random walk is periodic.
As we now prove, the curvature of the lazy random walk is closely related to that of the uniform random walk.

\begin{lemma}
	Let $T$ and $S$ be rooted phylogenetic trees with $n$ leaves.
	Then:
	\begin{enumerate}
		\item	$\curvature[\ell_p]{T,S} = \curvature{T,S}$, if $\dspr{T,S} > 1$, and
		\item	$\curvature{T,S} \le \curvature[\ell_p]{T,S} \le \curvature{T,S} + \frac{2}{\max(\degree{T}, \degree{S})}$, if $\dspr{T,S} = 1$.
	\end{enumerate}
\end{lemma}

\begin{proof}
	We first prove the lower bound, that is $\curvature{T,S} \le \curvature[\ell_p]{T,S}$.
	Let $W_1(T,S)$ be the mass transport cost in the uniform case, and $W_1'(T,S)$ be the same for the lazy case with parameter $p$.
	Recall that $\curvature{T,S} = \curvature[\ell_1]{T,S} = 1 - \frac{W_1(T,S)}{\dspr{T,S}}$, and $\curvature[\ell_p]{T,S} = (1 - \frac{W_1'(T,S)}{\dspr{T,S}}) / p$.
	Observe that $$W_1'(T,S) \le pW_1(T,S) + (1-p)\dspr{T,S},$$ by taking an optimal uniform mass assignment spread over $p$ of the mass and moving the remainder from $T$ to $S$ (or vice versa).
	Then:
	\begin{align*}
		\curvature[\ell_p]{T,S} &= (1 - \frac{W_1'(T,S)}{\dspr{T,S}}) / p \\
		&\ge (1 - \frac{pW_1(T,S) + (1-p)\dspr{T,S}}{\dspr{T,S}}) / p \\
		&\ge (\frac{1}{p} - \frac{W_1(T,S)}{\dspr{T,S}} - \frac{1-p}{p}) \\
		&\ge 1 - \frac{W_1(T,S)}{\dspr{T,S}} \\
		&\ge \curvature{T,S}
	\end{align*}

	For the upper bound, we observe that $$W_1'(T,S) \ge p(W_1(T,S) + (1-p)\left(\dspr{T,S}\right) - \frac{2}{\max(\degree{T}, \degree{S})},$$ as at most $\frac{1}{\max(\degree{T},\degree{S})}$ of the mass can remain at each of $T$ and $S$, paired with the lazy remainder.
	The upper bound then follows analogously to the lower bound.
	Moreover, no mass can remain at $T$ or $S$ when $\dspr{T,S} > 1$, in which case the curvatures are equal.
\end{proof}

We continue to explore the effect of biased random walks by considering the curvature of Metropolis Hastings random walks.
The Metropolis Hastings (MH) random walk proposes a move from a tree $T$ to a neighbor tree $S$ uniformly at random and then accepts the move according to the Hastings ratio, $\min\left(1, \frac{\degree{T}}{\degree{S}}\right)$.
The mass distribution for the MH random walk thus leaves a portion of mass at the origin tree, proportional to the relative degree difference of its higher degree neighbors.
We now bound the difference between the curvature of uniform random walks $\curvature{S,T}$, and that of MH random walks, $\curvature[\mathrm{MH}]{S,T}$.

\begin{lemma}
	Let $T$ and $S$ be phylogenetic trees with $n$ leaves. Then:
	$$\curvature{T,S} - \frac{1}{3\dspr{T,S}}
	\le \curvature[MH]{T,S}
	\le \curvature{T,S} + \frac{1}{3\dspr{T,S}}, \text{ and }$$
	$$\curvature{T,S} - \frac{1}{6}
	\le \curvature[MH]{T,S}
	\le \curvature{T,S} + \frac{1}{6}.$$
\end{lemma}
\begin{proof}
	We first prove the lower bound.
	By Lemma~\ref{lem:degree_max_delta_adjacent}, the quotient of degrees for two adjacent trees $\ge \frac{5}{6}$.
	Thus, the hastings ratio is always $\ge \frac{5}{6}$.
	This implies that at most $\frac{1}{6}$ of the mass remains at tree $T$ in the mass distribution.
	Let $W_1(T,S)$ be the cost of an optimal mass transport for the uniform random walk from $T$ to $S$.
	We construct an upper bound on $W_1'(T,S)$ for the MH random walk by moving mass according to $W_1$ where possible, and moving the remainder either from $T$ to $S$, $T$ to a neighbor of $S$, or from $T's$ neighbors to $S$.
	The maximum possible mass that is not moved according to $W_1$ is $\frac{1}{6}$.
	Moreover, the affected mass must be moved through at most two additional trees.
	Then, $W_1' \le W_1 + \frac{2}{6}$.
	We now have:
	\begin{align*}
		\curvature[\mathrm{MH}]{T,S} & \ge 1 - \frac{W_1 + \frac{1}{3}}{\dspr{T,S}} \\
		& \ge \curvature{T,S} - \frac{1}{3\dspr{T,S}}
	\end{align*}

	In the case that $\dspr{T,S}=1$, the affected mass must be moved through only at most one additonal tree, as $T$ and $S$ are adjacent.
	We thus obtain the lower bound of $\curvature{T,S} - \frac{1}{6}$ in this case.

	We obtain the upper bounds similarly to the lower bounds, by observing that the affected at most $\frac{1}{6}$ of the mass may move through at most two fewer trees (i.e. directly between $T$ and $S$ rather than a pair of neighbors at distance $\dspr{T,S} + 2$ from each other).
	Again, this is at most one fewer tree when $\dspr{T,S}=1$.

\end{proof}











\section{$k$-tubes}

The curvature with respect to two topologies, $T_1$ and $T_2$, is primarily determined by a subset of the SPR graph in the localized neighborhood of these topologies.
We first require some notation to define these subsets.
Let $\TT$ be the full set of topologies with a given number of leaves.
Denote the set of trees with SPR distance at most $k$ from a given tree $T$ by $N_k(T)$.
These trees are the $k$-neighbors of $T$.
That is, $$ N_k(T) = \set{t \in \TT \mid \dspr{T, t} \le k} .$$

We now define the $k$-tube of two trees $T_1$ and $T_2$ to be the union of their $k$-neighbors and \emph{every tree on a shortest path between a $k$-neighbor of $T_1$ and a $k$-neighbor of $T_2$}.
More formally, the $k$-tube for $T_1$ and $T_2$ is:
\[ \set{t \in \TT \mid \dspr{t, t_1} + \dspr{t, t_2} = \dspr{t_1, t_2},\ \exists_{t_1 \in N_k(T_1)},\ \exists_{t_2 \in N_k(T_2)} } .\]
We call $T_1$ and $T_2$ the centers of the $k$-tube.
The distance between $k$-neighbors of different central trees is bounded by the maximum distance from each $k$-neighbor to its respective center and the maximum distance between the centers:

\begin{lemma}
	\label{lem:neighbor_distance}
	$\dspr{t_1, t_2} \le \dspr{T_1, T_2} + 2k,\ \forall_{t_1 \in N_k(T_1)},\ \forall_{t_2 \in N_k(T_2)}.$
\end{lemma}

To efficiently compute a $k$-tube, we first bound the maximum distance from members of the $k$-tube to the closest central tree.
\begin{lemma}
	\label{lem:k_tube_distance}
	Any tree $t$ of the $k$-tube of two trees $T_1$ and $T_2$ satisfies:
	\[ \min\left({\dspr{t, T_1}, \dspr{t, T_2}}\right) \le \floor{\dspr{T_1, T_2}/2} + 2k .\]
\end{lemma}
\begin{proof}
Without loss of generality, assume that $t$ is on a shortest path between two trees $t_1 \in N_k(T_1)$ and $t_2 \in N_k(T_2)$, and is either closer to $t_1$ than $t_2$ or equidistant from both.
By Lemma~\ref{lem:neighbor_distance} there is a path of length at most $\dspr{T_1, T_2} + 2k$ between $t_1$ and $t_2$.
Then $\dspr{t, t_1} \le \floor{(\dspr{T_1, T_2} + 2k) / 2}$.

Along with the fact that $\dspr{T_1, t_1} \le k$, we have that
\begin{align*}
\dspr{t, T_1} &\le \dspr{t, t_1} + \dspr{t_1, T_1} \\
&\le \floor{(\dspr{T_1, T_2} + 2k) / 2} + k \\
&\le \floor{\dspr{T_1, T_2} / 2} + 2k.
\end{align*}

\end{proof}
We can thus restrict our search for members of the $k$-tube to topologies of distance at most $\floor{\dspr{T_1, T_2}/2} + 2k$ from the central trees.
We call this set of trees $k$-tube candidates.
Note that there are $\OhOf{n^{2(\floor{\dspr{T_1, T_2}/2} + 2k)}}$ $k$-tube candidates.
We identify these candidates by iterating over increasingly large $k$-neighbourhoods of $T_1$ and $T_2$, and removing duplicate topologies through hashing.

In the second part of our procedure for computing a $k$-tube, we identify $k$-tube candidates that are not on the shortest path between two $k$-neighbors of the central trees.
We first compute shortest path lengths from each member of $N_k(T_1)$ to each $k$-tube candidate using breadth-first search (BFS).
For each BFS traversal tree, we backtrack from members of $N_k(T_2)$, identifying topologies in the $k$-tube.
We can use unique tree indices here, rather than hashing, to avoid duplicates.
The size of $N_k(T_1)$ is $\OhOf{n^{2k}}$, so this takes
$\OhOf{ n^{2k} M}$ time, where $M$ is the number of edges between $k$-tube candidates, that is, at most the square of the number of $k$-tube candidates.

This procedure identifies exactly the trees in the $k$-tube, so we have the following lemma:
\begin{lemma}
	\label{lem:k_tube_correctness}
	This procedure correctly identifies the $k$-tube.
\end{lemma}
\begin{proof}
	First, suppose that this procedure identifies a tree $x$ that is not in the $k$-tube.
	Assume, without loss of generality, that the BFS tree $B$ from tree $t_1 \in N_k(T_1)$ transitioned from $x$ to a $k$-tube tree $t$.
	Moreover, there must be a path in $B$ from $t$ to a tree $t_2 \in N_k(T_2)$ such that $t$ is on a shortest path from $t_1$ to $t_2$.
	Then, by the properties of BFS, $x$ is on this shortest path and belongs in the $k$-tube.

	Now, suppose that this procedure does not identify a tree $x$ that belongs in the $k$-tube.
	$x$ must be on a shortest path between some trees $t_1 \in N_k(T_1)$ and $t_2 \in N_k(T_2)$.
	Then, by the properties of BFS, $x$ would have been on the path from $t_1$ to $t_2$ in the $t_1$ BFS tree.
\end{proof}

\section{Conclusion and future work}
This isn't quite the right graph to be looking at (rooted).

Want to investigate curvature of MCMC steps with a nontrivial likelihood function.
MCMC does both branch length and topology changes, thus this isn't the real thing.
Nevertheless, graph effects still matter.
\cite{Stefankovic2011-hu} take a chain where the likelihoods are the likelihoods maximized across branch length.

Ranked trees \cite{Song2006-xe}
Partitions \cite{Gusfield2002-il}


\section{Acknowledgements}
Alex Gavruskin,
Vladimir Minin,

This work was funded by National Science Foundation award 1223057.

\bibliographystyle{unsrt}
\bibliography{curvature}
\end{document}

