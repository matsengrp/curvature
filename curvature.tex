\documentclass{amsart}

\usepackage{amsmath}
\usepackage{ifthen}
\usepackage{todonotes}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{example}[theorem]{Example}
\newtheorem{definition}[theorem]{Definition}

\newcommand{\RR}{\mathbb R}
\newcommand{\TT}{\mathcal T}

%---[ Parenthesization ]--------------------------------------------------------

\newcommand{\newparentheses}[3]{%
  \expandafter\newcommand\csname #1\endcsname[1]{#2##1#3}%
  \expandafter\newcommand\csname #1L\endcsname[1]{\bigl#2##1\bigr#3}%
  \expandafter\newcommand\csname #1XL\endcsname[1]{\Bigl#2##1\Bigr#3}%
  \expandafter\newcommand\csname #1V\endcsname[1]{\left#2##1\right#3}}

\newparentheses{parens}{(}{)}
\newparentheses{floor}{\lfloor}{\rfloor}
\newparentheses{ceil}{\lceil}{\rceil}
\newparentheses{abs}{|}{|}
\newparentheses{set}{\{}{\}}
\newparentheses{size}{|}{|}

%---[ Attributes ]--------------------------------------------------------------

\makeatletter
\newcommand{\onenewattribute}[3]{%
  \@ifundefined{#1}{\let\@@def\newcommand}{\let\@@def\renewcommand}%
  \expandafter\@@def\csname #1\endcsname[2][]{%
    \ifthenelse{\equal{##1}{}}%
    {#2\csname #3\endcsname{##2}}%
    {#2_{##1}\csname #3\endcsname{##2}}}}
\newcommand{\newattribute}[2]{%
  \onenewattribute{#1}{#2}{parens}%
  \onenewattribute{#1L}{#2}{parensL}%
  \onenewattribute{#1XL}{#2}{parensXL}%
  \onenewattribute{#1V}{#2}{parensV}}
\makeatother

%---[ Asymptotic notation ]-----------------------------------------------------

\newattribute{OhOf}{\mathrm{O}}
\newattribute{ThetaOf}{\Theta}
\newattribute{OmegaOf}{\Omega}
\newattribute{ohOf}{\mathrm{o}}
\newattribute{omegaOf}{\omega}
\newattribute{lca}{\text{LCA}}
%\newattribute{min}{\text{min}}
%\newattribute{max}{\text{max}}

%---[ Distance measures, invocations, etc ]-------------------------------------
\newattribute{dspr}{d_{\mathrm{SPR}}}


\begin{document}
\title{Ricci curvature of the phylogenetic subtree-prune-regraft graph}
\author[Whidden]{Christopher Whidden}
\author[Matsen]{Frederick Matsen}
\address{}
\thanks{}

\date{\today}

\begin{abstract}
\end{abstract}

\maketitle

% % Make a todo table of contents.
% \makeatletter
% \providecommand\@dotsep{5}
% \makeatother
% \listoftodos\relax


\section{Introduction}

\section{Rooted SPR Neighborhoods}

\begin{lemma}
\label{lem:degree_change}
Let $T$ and $S$ be phylogenetic trees such that $\dspr{T,S}=1$, that is $T$ can be transformed into $S$ by moving a subtree $R$ with $k$ leaves.
The corresponding SPR operation moves $R$ from its position adjacent to subtree $U$ to a location adjacent to subtree $V$.
Let $L$ be the $\lca{U,V}$ in $T$.
Let $a$ be the number of intermediate nodes on the path from the parent of $R$ to $L$ in $T$ excluding endpoints.
Similarly, let $b$ be the number of intermediate nodes on the path from $V$ to $L$ in $T$, excluding endpoints.
Let $i$ be the number of leaves in $U$, excluding any leaves of $R$, and $j$ be the number of leaves in $V$, excluding any leaves of $R$.
Then the degree of $T$ and $S$ differs by:
$$2(k(a-b) + i - j).$$

\end{lemma}
\begin{proof}

Observe that the set of permissible moves changes after the movement of $R$ in four different ways: 1) Subtrees on the path from $U$ to $L$ may now be moved within $R$ and its newly introduced parent, 2) Subtrees on the path from $V$ to $L$ may no longer be moved within $R$ and its parent, 3) $R$'s parent subtree may now be moved within $U$, and 4) $R$'s parent subtree may no longer be moved within $V$.
Note that no additional moves are introduced or blocked by the SPR operation.

In the first case, there are $a$ subtrees that can now be moved to the $2k$ positions within $R$, including its newly introduced parent node, for a total gain of $2ka$ moves.
Similarly, we lose $2kb$ moves in the second case.

In the third case, $R's$ parent subtree may now make $2(i-1)$ moves within $U$.
Similarly, we lose $2(j-1)$ moves in the fourth case.

The difference in SPR degree is thus:
\begin{align*}
&2ka - 2kb + 2(i-1) - 2(j-1) \\
=\  &2(k(a-b) + i - j)
\end{align*}
\end{proof}

\begin{corollary}
\label{cor:paired_neighbors}
Let the degrees of $T$ and $S$ be $q$ and $p$ respectively.
Then at least $o = q - 2kb - 2(j-1) = p - 2ka - 2(i-1)$ trees in the neighborhood of $T$ can be paired with $o$ trees in the neighborhood of $S$ such that:
\begin{enumerate}
\item $\dspr{T',S'} = 1$ for each $(T',S')$ pair, and
\item each neighbor of $T$ and each neighbor of $S$ is paired to exactly one tree.
\end{enumerate}
\end{corollary}
\begin{proof}
By the same arguments as in the proof of Lemma~\ref{lem:degree_change}, $o$ SPR moves can be applied to $T$ and $S$ with the same source and target nodes.
For each such $(T',S')$ pair, we can move $R$ in either tree to obtain the other member of the pair.
\end{proof}



\section{Curvature}


Note that we have to write out simple random walk versus degree-informed.
Can we just say that degree differences are small relative to $n$? Is that true?


\begin{proposition}
Fix a positive integer $k$ and let $R$ be a tree with $k$ leaves.
Let $\{T_n \mid n > k\}$ be a sequence of phylogenetic trees all containing $R$, and let $\{S_n \mid n > k\}$ be the same sequence but with $R$ cut off and attached at a different location for each $T_n$.
Then $\lim_{n \rightarrow \infty} \kappa(T_n, S_n) = 0$ on the SPR graph.
\end{proposition}
\begin{proof}
First we show that $\kappa$ is bounded above by $(q_n+3(2k-1)(\OhOf{n}))/q_n$, where $q_n$ is the number of neighbors of $T_n$ and $S_n$.
Let $T'_n$ be any of the $o$ SPR moves from a pairing following Corollary~\ref{cor:paired_neighbors}.
In the mass transport, we pair $T'_n$ with $S'_n$, which is the same move applied to $S_n$ such that $\dspr{T'_n, S'_n} = 1$.
The number of trees unmatched by this pairing is $\OhOf{kn}$, and their distance is at most 3.
Thus, $\kappa$ is bounded above by $(q_n + 2\OhOf{kn}) / q_n$.

A lower bound is also available because we can't do better than distance 1 for all trees unless they move $R$.
There are only $\OhOf{n}$ pairs with trees that move $R$.
By ignoring these trees we get a lower bound of $(q_n -(\OhOf{n}))/q_n$.

The proposition follows because $q_n$ is quadratic in $n$.

Now, we prove the proposition when the number of neighbors differ.
Let $q_n$ and $p_n$ be the number of neighbors of $T_n$ and $S_n$, respectively.
Assume without loss of generality that $q_n < p_n$.
By Lemma~\ref{lem:degree_change}, $p_n - q_n = 2(k(a-b) + i - j)$, where $a,b,i,j < n$.
Thus, $p_n - q_n = \OhOf{kn}$.
We again pair $T'_n$ with $S'_n$ such that $\dspr{T'_n, S'_n}=1$ but, as $p_n > q_n$ we can only account for at most $q_n / p_n$ of the mass directly and may have to move the $(p_n - q_n) / p_n$ remainder to trees at distance at most 3.
Thus, $\kappa$ is bounded above by $(q_n + 3\OhOf{kn}) / p_n = (p_n + 2\OhOf{kn}) / p_n$.
We again bound $\kappa$ from below with $(q_n - \OhOf{n}) / q_n$ by ignoring the mass in trees that may overlap.
The proposition again follows because $q_n$ is quadratic in $n$.

\end{proof}


\section{$k$-tubes}

The curvature with respect to two topologies, $T_1$ and $T_2$, is primarily determined by a subset of the SPR graph in the localized neighborhood of these topologies.
We first require some notation to define these subsets.
Let $\TT$ be the full set of topologies with a given number of leaves.
Denote the set of trees with SPR distance at most $k$ from a given tree $T$ by $N_k(T)$.
These trees are the $k$-neighbors of $T$.
That is, $$ N_k(T) = \set{t \in \TT \mid \dspr{T, t} \le k} .$$

We now define the $k$-tube of two trees $T_1$ and $T_2$ to be the union of their $k$-neighbors and \emph{every tree on a shortest path between a $k$-neighbor of $T_1$ and a $k$-neighbor of $T_2$}.
More formally, the $k$-tube for $T_1$ and $T_2$ is:
\[ \set{t \in \TT \mid \dspr{t, t_1} + \dspr{t, t_2} = \dspr{t_1, t_2},\ \exists_{t_1 \in N_k(T_1)},\ \exists_{t_2 \in N_k(T_2)} } .\]
We call $T_1$ and $T_2$ the centers of the $k$-tube.
The distance between $k$-neighbors of different central trees is bounded by the maximum distance from each $k$-neighbor to its respective center and the maximum distance between the centers:

\begin{lemma}
	\label{lem:neighbor_distance}
	$\dspr{t_1, t_2} \le \dspr{T_1, T_2} + 2k,\ \forall_{t_1 \in N_k(T_1)},\ \forall_{t_2 \in N_k(T_2)}.$
\end{lemma}

To efficiently compute a $k$-tube, we first bound the maximum distance from members of the $k$-tube to the closest central tree.
\begin{lemma}
	\label{lem:k_tube_distance}
	Any tree $t$ of the $k$-tube of two trees $T_1$ and $T_2$ satisfies:
	\[ \min\left({\dspr{t, T_1}, \dspr{t, T_2}}\right) \le \floor{\dspr{T_1, T_2}/2} + 2k .\]
\end{lemma}
\begin{proof}
Without loss of generality, assume that $t$ is on a shortest path between two trees $t_1 \in N_k(T_1)$ and $t_2 \in N_k(T_2)$, and is either closer to $t_1$ than $t_2$ or equidistant from both.
By Lemma~\ref{lem:neighbor_distance} there is a path of length at most $\dspr{T_1, T_2} + 2k$ between $t_1$ and $t_2$.
Then $\dspr{t, t_1} \le \floor{(\dspr{T_1, T_2} + 2k) / 2}$.

Along with the fact that $\dspr{T_1, t_1} \le k$, we have that
\begin{align*}
\dspr{t, T_1} &\le \dspr{t, t_1} + \dspr{t_1, T_1} \\
&\le \floor{(\dspr{T_1, T_2} + 2k) / 2} + k \\
&\le \floor{\dspr{T_1, T_2} / 2} + 2k.
\end{align*}

\end{proof}
We can thus restrict our search for members of the $k$-tube to topologies of distance at most $\floor{\dspr{T_1, T_2}/2} + 2k$ from the central trees.
We call this set of trees $k$-tube candidates.
Note that there are $\OhOf{n^{2(\floor{\dspr{T_1, T_2}/2} + 2k)}}$ $k$-tube candidates.
We identify these candidates by iterating over increasingly large $k$-neighbourhoods of $T_1$ and $T_2$, and removing duplicate topologies through hashing.  \todo{We might be able to do better by using ``edge protection'' to avoid duplicates. I need to check how accurately neighbourhood sizes follow the naive $\OhOf(n^{2k})$ bound.}

In the second part of our procedure for computing a $k$-tube, we identify $k$-tube candidates that are not on the shortest path between two $k$-neighbors of the central trees.
We first compute shortest path lengths from each member of $N_k(T_1)$ to each $k$-tube candidate using breadth-first search (BFS).
For each BFS traversal tree, we backtrack from members of $N_k(T_2)$, identifying topologies in the $k$-tube.
We can use unique tree indices here, rather than hashing, to avoid duplicates.
The size of $N_k(T_1)$ is $\OhOf{n^{2k}}$, so this takes
$\OhOf( n^{2k} M)$ time, where $M$ is the number of edges between $k$-tube candidates, that is, at most the square of the number of $k$-tube candidates. \todo{We could probably do something smarter by starting from trees that are 0, 1, etc SPRs from $T_1$.}

This procedure identifies exactly the trees in the $k$-tube, so we have the following lemma:
\begin{lemma}
	\label{lem:k_tube_correctness}
	This procedure correctly identifies the $k$-tube.
\end{lemma}
\begin{proof}
	First, suppose that this procedure identifies a tree $x$ that is not in the $k$-tube.
	Assume, without loss of generality, that the BFS tree $B$ from tree $t_1 \in N_k(T_1)$ transitioned from $x$ to a $k$-tube tree $t$.
	Moreover, there must be a path in $B$ from $t$ to a tree $t_2 \in N_k(T_2)$ such that $t$ is on a shortest path from $t_1$ to $t_2$.
	Then, by the properties of BFS, $x$ is on this shortest path and belongs in the $k$-tube.

	Now, suppose that this procedure does not identify a tree $x$ that belongs in the $k$-tube.
	$x$ must be on a shortest path between some trees $t_1 \in N_k(T_1)$ and $t_2 \in N_k(T_2)$.
	Then, by the properties of BFS, $x$ would have been on the path from $t_1$ to $t_2$ in the $t_1$ BFS tree.
\end{proof}

% \bibliographystyle{plain}
% \bibliography{curvature}
\end{document}

